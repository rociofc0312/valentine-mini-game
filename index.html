<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Misi√≥n de Amor</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      overflow: hidden;
      overflow-x: hidden;
      overflow-y: hidden;
      height: 100%;
      width: 100%;
      position: fixed;
      top: 0;
      left: 0;
    }

    body {
      font-family: 'Courier New', monospace;
      background: #0a0a0a;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #fff;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background:
        repeating-linear-gradient(
          0deg,
          rgba(0,0,0,0.1) 0px,
          rgba(0,0,0,0.1) 1px,
          transparent 1px,
          transparent 2px
        );
      pointer-events: none;
      z-index: 9999;
    }

    .game-container {
      width: 100%;
      max-width: 500px;
      max-height: 100vh;
      padding: 10px 20px;
      text-align: center;
      overflow: hidden;
    }

    .title {
      font-size: 1.4rem;
      margin-bottom: 10px;
      color: #cc0033;
      text-shadow: 0 0 10px #cc0033, 0 0 20px #cc003366;
      text-transform: uppercase;
      letter-spacing: 3px;
    }

    .screen {
      display: none;
      background: #111;
      border: 3px solid #cc0033;
      border-radius: 0;
      padding: 15px;
      box-shadow: 0 0 20px #cc003344, inset 0 0 30px #00000088;
    }

    .screen.active {
      display: block;
    }

    .btn {
      background: #1a1a1a;
      color: #cc0033;
      border: 2px solid #cc0033;
      padding: 10px 20px;
      font-size: 0.9rem;
      font-family: 'Courier New', monospace;
      border-radius: 0;
      cursor: pointer;
      margin: 4px;
      transition: all 0.1s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .btn:hover {
      background: #cc0033;
      color: #fff;
      box-shadow: 0 0 20px #cc003388;
    }

    .btn:disabled {
      background: #111;
      border-color: #333;
      color: #333;
      cursor: not-allowed;
      box-shadow: none;
    }

    .btn-secondary {
      background: #111;
      border-color: #444;
      color: #666;
    }

    .btn-secondary:hover {
      background: #222;
      border-color: #cc0033;
      color: #cc0033;
    }

    .progress-bar {
      width: 100%;
      height: 15px;
      background: #0a0a0a;
      border-radius: 0;
      margin: 10px 0;
      overflow: hidden;
      border: 2px solid #333;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #990022, #cc0033);
      transition: width 0.3s;
      box-shadow: 0 0 10px #cc003366;
    }

    .message-reveal {
      background: #0a0a0a;
      padding: 10px;
      border-radius: 0;
      margin: 10px 0;
      font-style: italic;
      color: #cc0033;
      min-height: 40px;
      border: 1px solid #cc003344;
      text-shadow: 0 0 5px #cc003366;
      font-size: 0.9rem;
    }

    .lives {
      font-size: 1.1rem;
      margin: 5px 0;
    }

    .timer {
      font-size: 1.1rem;
      color: #cc0033;
      margin: 5px 0;
      text-shadow: 0 0 10px #cc003366;
    }

    .level-select-grid {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin: 10px 0;
    }

    .level-btn {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      background: #111;
      border: 2px solid #333;
      border-radius: 0;
      color: #555;
      transition: all 0.1s ease;
      font-size: 0.85rem;
    }

    .level-btn.unlocked {
      border-color: #cc0033;
      color: #fff;
      cursor: pointer;
    }

    .level-btn.unlocked:hover {
      background: #1a1a1a;
      box-shadow: 0 0 10px #cc003344;
    }

    .level-btn.completed {
      border-color: #d4af37;
      box-shadow: 0 0 10px #d4af3744;
    }

    .level-btn .status {
      font-size: 0.8rem;
      text-transform: uppercase;
    }

    /* Heart Catcher Styles */
    #heart-catcher-canvas {
      background: #0a0a0a;
      border-radius: 0;
      display: block;
      margin: 0 auto;
      border: 2px solid #333;
      max-width: 100%;
      height: auto;
    }

    /* Memory Match Styles */
    .memory-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
      margin: 10px 0;
      max-width: 300px;
      margin-left: auto;
      margin-right: auto;
    }

    .memory-card {
      aspect-ratio: 1;
      background: linear-gradient(135deg, #990022 0%, #cc0033 100%);
      border-radius: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.5rem;
      cursor: pointer;
      transition: all 0.1s ease;
      border: 2px solid #cc0033;
      overflow: hidden;
    }

    .memory-card:hover {
      box-shadow: 0 0 15px #cc003366;
    }

    .memory-card.flipped, .memory-card.matched {
      background: #111;
      border: 2px solid #cc0033;
    }

    .memory-card.matched {
      border-color: #d4af37;
      cursor: default;
      box-shadow: 0 0 10px #d4af3744;
    }

    .memory-card:not(.flipped):not(.matched):hover {
      transform: scale(1.05);
    }

    .memory-card img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .memory-card.swapping {
      animation: swapFlash 0.6s ease-in-out;
      border-color: #ff6600 !important;
      box-shadow: 0 0 25px #ff6600, 0 0 50px #ff660066 !important;
      z-index: 10;
    }

    @keyframes swapFlash {
      0% { transform: scale(1); border-color: #cc0033; }
      25% { transform: scale(1.15) rotate(-3deg); border-color: #ff6600; }
      50% { transform: scale(1.15) rotate(3deg); border-color: #ff6600; }
      75% { transform: scale(1.15) rotate(-3deg); border-color: #ff6600; }
      100% { transform: scale(1); border-color: #cc0033; }
    }

    /* Maze Styles */
    #maze-canvas {
      background: #0a0a0a;
      border-radius: 0;
      display: block;
      margin: 0 auto;
      border: 2px solid #333;
      position: relative;
      z-index: 10000;
    }

    .maze-controls {
      display: grid;
      grid-template-columns: repeat(3, 45px);
      gap: 4px;
      justify-content: center;
      margin-top: 10px;
    }

    .maze-controls .btn {
      padding: 10px;
      font-size: 1rem;
    }

    /* Trivia Styles */
    .trivia-question {
      font-size: 1rem;
      margin: 10px 0;
      padding: 15px;
      background: #0a0a0a;
      border-radius: 0;
      border: 2px solid #333;
      color: #fff;
    }

    .trivia-input {
      width: 100%;
      padding: 10px;
      font-size: 0.9rem;
      font-family: 'Courier New', monospace;
      background: #0a0a0a;
      border: 2px solid #cc0033;
      border-radius: 0;
      color: #fff;
      margin: 8px 0;
    }

    .trivia-input:focus {
      outline: none;
      box-shadow: 0 0 15px #cc003344;
    }

    .strikes {
      color: #cc0033;
      font-size: 1rem;
      text-shadow: 0 0 10px #cc003366;
    }

    /* Lovedle Styles */
    .lovedle-grid {
      display: flex;
      flex-direction: column;
      gap: 5px;
      margin: 10px 0;
    }

    .lovedle-row {
      display: flex;
      gap: 5px;
      justify-content: center;
    }

    .lovedle-cell {
      width: 42px;
      height: 42px;
      border: 2px solid #333;
      border-radius: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.3rem;
      font-weight: bold;
      text-transform: uppercase;
      background: #111;
      color: #fff;
      font-family: 'Courier New', monospace;
    }

    .lovedle-cell.correct {
      background: #d4af37;
      border-color: #d4af37;
      color: #0a0a0a;
      box-shadow: 0 0 10px #d4af3766;
    }

    .lovedle-cell.present {
      background: #8b4513;
      border-color: #8b4513;
      color: #fff;
      box-shadow: 0 0 10px #8b451366;
    }

    .lovedle-cell.absent {
      background: #222;
      border-color: #222;
    }

    .keyboard {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 10px;
    }

    .keyboard-row {
      display: flex;
      justify-content: center;
      gap: 3px;
    }

    .key {
      padding: 8px 10px;
      background: #1a1a1a;
      border: 2px solid #333;
      border-radius: 0;
      color: #fff;
      font-family: 'Courier New', monospace;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.1s ease;
    }

    .key:hover {
      background: #333;
      border-color: #cc0033;
    }

    .key.wide {
      padding: 10px 15px;
      font-size: 0.8rem;
    }

    .key.correct {
      background: #d4af37;
      border-color: #d4af37;
      color: #0a0a0a;
    }

    .key.present {
      background: #8b4513;
      border-color: #8b4513;
      color: #fff;
    }

    .key.absent {
      background: #111;
      border-color: #111;
      color: #333;
    }

    /* Prize Photos */
    .prize-photo-container {
      margin: 10px 0;
      position: relative;
    }

    .prize-photo {
      max-width: 100%;
      max-height: 150px;
      border-radius: 0;
      border: 3px solid #cc0033;
      box-shadow: 0 0 20px #cc003344;
    }

    .prize-caption {
      font-style: italic;
      color: #d4af37;
      margin-top: 8px;
      font-size: 0.8rem;
      text-shadow: 0 0 10px #d4af3744;
    }

    /* Final Screen */
    .final-message {
      font-size: 1rem;
      margin: 10px 0;
      padding: 15px;
      background: #0a0a0a;
      border-radius: 0;
      border: 2px solid #cc0033;
      line-height: 1.6;
      color: #fff;
      box-shadow: 0 0 20px #cc003333;
    }

    .final-question {
      font-size: 1.4rem;
      color: #cc0033;
      margin: 15px 0;
      text-shadow: 0 0 20px #cc003388;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .confetti {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1000;
    }

    /* Love Code */
    .love-code-display {
      background: #0a0a0a;
      padding: 10px;
      border-radius: 0;
      margin: 8px 0;
      font-size: 1rem;
      border: 2px dashed #cc0033;
      letter-spacing: 2px;
      color: #cc0033;
      text-shadow: 0 0 10px #cc003366;
    }

    .code-input {
      width: 180px;
      padding: 8px;
      font-size: 0.9rem;
      font-family: 'Courier New', monospace;
      background: #0a0a0a;
      border: 2px solid #cc0033;
      border-radius: 0;
      color: #fff;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .code-input:focus {
      outline: none;
      box-shadow: 0 0 15px #cc003344;
    }

    .fail-message {
      color: #cc0033;
      margin: 15px 0;
      text-shadow: 0 0 5px #cc003366;
    }

    .success-message {
      color: #d4af37;
      margin: 15px 0;
      text-shadow: 0 0 5px #d4af3766;
    }

    .hint-text {
      color: #666;
      font-size: 0.8rem;
      margin-top: 8px;
      margin-bottom: 0;
    }

    /* Pause Button & Overlay */
    .pause-btn {
      background: #1a1a1a;
      color: #666;
      border: 2px solid #444;
      padding: 5px 10px;
      font-family: 'Courier New', monospace;
      font-size: 0.75rem;
      cursor: pointer;
      margin-top: 8px;
    }

    .pause-btn:hover {
      background: #cc0033;
      color: #fff;
      border-color: #cc0033;
    }

    .pause-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      z-index: 15000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    .pause-overlay.active {
      display: flex;
    }

    .pause-overlay h2 {
      color: #cc0033;
      font-size: 2rem;
      margin-bottom: 30px;
      text-transform: uppercase;
      letter-spacing: 4px;
    }

    /* Animations */
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    .shake {
      animation: shake 0.3s ease-in-out;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .pulse {
      animation: pulse 0.5s ease-in-out;
    }

    /* Fail Modal */
    .fail-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.85);
      z-index: 15000;
      justify-content: center;
      align-items: center;
    }

    .fail-modal.active {
      display: flex;
    }

    .fail-modal-content {
      background: #111;
      border: 3px solid #cc0033;
      padding: 30px;
      text-align: center;
      box-shadow: 0 0 30px #cc003366;
    }
  </style>
</head>
<body>
  <div class="game-container">
    <!-- Start Screen -->
    <div id="start-screen" class="screen active">
      <h1 class="title">Misi√≥n de Amor</h1>
      <p style="margin-bottom: 20px;">¬°Completa todos los desaf√≠os para desbloquear un mensaje especial!</p>

      <div id="start-buttons">
        <button class="btn" onclick="startNewGame()">Nueva Partida</button>
        <button class="btn btn-secondary" onclick="showCodeInput()">Ingresar C√≥digo</button>
      </div>

      <div id="code-input-section" style="display: none; margin-top: 20px;">
        <input type="text" class="code-input" id="love-code-input" placeholder="LOVE-X-XXXX" maxlength="12">
        <br><br>
        <button class="btn" onclick="loadFromCode()">Continuar</button>
        <button class="btn btn-secondary" onclick="hideCodeInput()">Volver</button>
        <p id="code-error" class="fail-message" style="display: none;"></p>
      </div>

      <div id="resume-prompt" style="display: none; margin-top: 20px;">
        <p>¬°Bienvenido de nuevo! Estabas en el Nivel <span id="resume-level"></span></p>
        <button class="btn" onclick="resumeGame()">Continuar</button>
        <button class="btn btn-secondary" onclick="startNewGame()">Empezar de Nuevo</button>
      </div>
    </div>

    <!-- Level Select Screen -->
    <div id="level-select-screen" class="screen">
      <h1 class="title">Seleccionar Nivel</h1>

      <div class="message-reveal" style="font-size: 0.75rem; line-height: 1.3; padding: 10px;">
        Feliz aniversario de 6 meses cari√±o! ‚ù§Ô∏è Tengo una pregunta para ti üëÄ completa los niveles y la desbloquear√°s, al completar cada nivel, recibir√°s un peque√±o detalle (algunos deber√°s canjearlos directamente conmigo ü§î).
      </div>

      <div class="level-select-grid" id="level-select-grid">
        <!-- Generated by JS -->
      </div>

      <div style="margin-top: 20px;">
        <p style="color: #888; font-size: 0.9rem;">Tu C√≥digo de Amor:</p>
        <div class="love-code-display" id="current-love-code">LOVE-0-XXXX</div>
        <button class="btn btn-secondary" onclick="copyLoveCode()">Copiar C√≥digo</button>
      </div>
    </div>

    <!-- Nivel 1: Atrapalo ranita! -->
    <div id="level-1-screen" class="screen">
      <h2 class="title">Nivel 1: Atr√°palo ranita!</h2>
      <p>¬°Atrapa 10 corazones! ¬°Evita los rotos!</p>

      <div class="timer">Tiempo: <span id="catcher-timer">45</span>s</div>
      <div class="lives" id="lives">Vidas: <span id="lives-count"></span></div>
      <div>Puntos: <span id="catch-score">0</span>/10</div>

      <canvas id="heart-catcher-canvas" width="320" height="280"></canvas>

      <p class="hint-text">Usa las flechas o A/D para moverte</p>
      <button class="pause-btn" onclick="togglePause(1)">‚è∏ PAUSA</button>
      <p id="catcher-fail-msg" class="fail-message" style="display: none;"></p>
    </div>

    <!-- Nivel 2: Memoria de Series -->
    <div id="level-2-screen" class="screen">
      <h2 class="title">Nivel 2: Memoria de Series</h2>
      <p>¬°Encuentra todas las parejas antes de que se acabe el tiempo!</p>

      <div class="timer">Tiempo: <span id="memory-timer">60</span>s</div>
      <div>Parejas: <span id="pairs-matched">0</span>/8</div>

      <div class="memory-grid" id="memory-grid">
        <!-- Generated by JS -->
      </div>

      <button class="pause-btn" onclick="togglePause(2)">‚è∏ PAUSA</button>
      <p id="memory-fail-msg" class="fail-message" style="display: none;"></p>
    </div>

    <!-- Nivel 3: Encuentrame! -->
    <div id="level-3-screen" class="screen">
      <h2 class="title">Nivel 3: Encuentrame! üîç</h2>
      <p>¬°Gu√≠a el coraz√≥n hasta el sobre!</p>

      <div class="timer">Tiempo: <span id="maze-timer">35</span>s</div>

      <canvas id="maze-canvas" width="300" height="300"></canvas>

      <div class="maze-controls">
        <div></div>
        <button class="btn" onclick="moveMaze('up')">^</button>
        <div></div>
        <button class="btn" onclick="moveMaze('left')">&lt;</button>
        <button class="btn" onclick="moveMaze('down')">v</button>
        <button class="btn" onclick="moveMaze('right')">&gt;</button>
      </div>

      <p class="hint-text">Usa las flechas o los botones para moverte</p>
      <button class="pause-btn" onclick="togglePause(3)">‚è∏ PAUSA</button>
      <p id="maze-fail-msg" class="fail-message" style="display: none;"></p>
    </div>

    <!-- Level 4: Trivia -->
    <div id="level-4-screen" class="screen">
      <h2 class="title">Nivel 4: Nos conoces?</h2>
      <p>¬øCu√°nto sabes de nosotros?</p>

      <div class="strikes">Errores: <span id="strikes-count">0</span>/3</div>
      <div>Pregunta: <span id="trivia-progress">1</span>/6</div>

      <div class="trivia-question" id="trivia-question"></div>

      <div id="trivia-inputs-container">
        <input type="text" class="trivia-input" id="trivia-input" placeholder="Escribe tu respuesta...">
      </div>
      <button class="btn" onclick="checkTriviaAnswer()">Enviar</button>

      <p id="trivia-fail-msg" class="fail-message" style="display: none;"></p>
      <p id="trivia-hint" class="hint-text" style="display: none;"></p>
    </div>

    <!-- Level 5: Aprende a Programar -->
    <div id="level-5-screen" class="screen">
      <!-- Phase 0: Intro -->
      <div id="prog-intro-phase" style="display: none;">
        <h2 class="title">Nivel 5: Programa conmigo</h2>
        <p style="margin: 20px 0; font-size: 1rem;">¬°Bienvenido al nivel final!</p>

        <div style="background: #0a0a0a; padding: 20px; border: 2px solid #333; margin: 20px 0; text-align: left;">
          <p style="margin-bottom: 15px; color: #d4af37; font-weight: bold;">Este nivel tiene 4 fases:</p>

          <p style="margin: 10px 0;"><span style="color: #cc0033;">üìñ Fase 1:</span> Aprende conceptos b√°sicos de programaci√≥n</p>
          <p style="margin: 10px 0;"><span style="color: #cc0033;">üìö Fase 2:</span> Responde un quiz sobre lo aprendido</p>
          <p style="margin: 10px 0;"><span style="color: #cc0033;">üî® Fase 3:</span> Ordena l√≠neas de c√≥digo para crear un programa</p>
          <p style="margin: 10px 0;"><span style="color: #cc0033;">üêõ Fase 4:</span> Encuentra y corrige errores en el c√≥digo</p>

          <p style="margin-top: 20px; font-size: 0.9rem; color: #d4af37;">
            No necesitas saber programar. ¬°Aprender√°s en el camino!
          </p>
        </div>

        <button class="btn" onclick="startQuizPhase()" style="margin-top: 20px;">¬°Comenzar!</button>
      </div>

      <!-- Phase 1: Tutorial de Conceptos -->
      <div id="prog-tutorial-phase" style="display: none;">
        <h2 class="title">Conceptos de Programaci√≥n</h2>
        <p style="margin-bottom: 15px;">Aprende estos conceptos b√°sicos. ¬°Los necesitar√°s!</p>

        <div style="background: #0a0a0a; padding: 15px; border: 2px solid #333; margin: 15px 0; text-align: left; max-height: 400px; overflow-y: auto;">

          <div style="margin-bottom: 20px;">
            <h3 style="color: #d4af37; font-size: 1rem; margin-bottom: 8px;">üì¶ Variables</h3>
            <p style="font-size: 0.9rem; margin-bottom: 5px;">Las variables guardan informaci√≥n. Se declaran con <code style="color: #0f0;">let</code>:</p>
            <code style="display: block; background: #000; padding: 8px; color: #0f0; font-size: 0.85rem;">let nombre = "Rocio";</code>
          </div>

          <div style="margin-bottom: 20px;">
            <h3 style="color: #d4af37; font-size: 1rem; margin-bottom: 8px;">üí¨ Strings (Texto)</h3>
            <p style="font-size: 0.9rem; margin-bottom: 5px;">El texto se escribe entre comillas:</p>
            <code style="display: block; background: #000; padding: 8px; color: #0f0; font-size: 0.85rem;">let mensaje = "Te amo";</code>
          </div>

          <div style="margin-bottom: 20px;">
            <h3 style="color: #d4af37; font-size: 1rem; margin-bottom: 8px;">‚ùì Comparaciones</h3>
            <p style="font-size: 0.9rem; margin-bottom: 5px;">Para comparar valores usamos <code style="color: #0f0;">===</code> (tres signos igual):</p>
            <code style="display: block; background: #000; padding: 8px; color: #0f0; font-size: 0.85rem;">if (respuesta === "s√≠") { }</code>
            <p style="font-size: 0.85rem; color: #999; margin-top: 5px;">‚ö†Ô∏è Un solo <code>=</code> asigna, no compara</p>
          </div>

          <div style="margin-bottom: 20px;">
            <h3 style="color: #d4af37; font-size: 1rem; margin-bottom: 8px;">‚û∞ Loops (Bucles)</h3>
            <p style="font-size: 0.9rem; margin-bottom: 5px;">Los loops repiten acciones m√∫ltiples veces. Este ejemplo imprime "Te amo" 5 veces:</p>
            <code style="display: block; background: #000; padding: 8px; color: #0f0; font-size: 0.85rem;">for(let i = 0; i < 5; i++) {<br>  console.log("Te amo");<br>}</code>
            <p style="font-size: 0.85rem; color: #999; margin-top: 5px;">‚Ä¢ <code style="color: #0f0;">i++</code> suma 1 cada vez (0, 1, 2, 3, 4)<br>‚Ä¢ <code style="color: #0f0;">i--</code> resta 1 cada vez (puede causar loop infinito)</p>
          </div>

          <div style="margin-bottom: 20px;">
            <h3 style="color: #d4af37; font-size: 1rem; margin-bottom: 8px;">üí¨ Comentarios</h3>
            <p style="font-size: 0.9rem; margin-bottom: 5px;">Los comentarios explican el c√≥digo y se ignoran al ejecutar:</p>
            <code style="display: block; background: #000; padding: 8px; color: #0f0; font-size: 0.85rem;">// Esto es un comentario</code>
          </div>

          <div style="margin-bottom: 20px;">
            <h3 style="color: #d4af37; font-size: 1rem; margin-bottom: 8px;">‚ûï Concatenar (Unir texto)</h3>
            <p style="font-size: 0.9rem; margin-bottom: 5px;">Usamos <code style="color: #0f0;">+</code> para unir strings:</p>
            <code style="display: block; background: #000; padding: 8px; color: #0f0; font-size: 0.85rem;">"Hola " + "Mundo"  // "Hola Mundo"</code>
          </div>

          <div style="margin-bottom: 20px;">
            <h3 style="color: #d4af37; font-size: 1rem; margin-bottom: 8px;">üñ®Ô∏è Console.log()</h3>
            <p style="font-size: 0.9rem; margin-bottom: 5px;">Muestra mensajes en la consola:</p>
            <code style="display: block; background: #000; padding: 8px; color: #0f0; font-size: 0.85rem;">console.log("Hola!");</code>
          </div>

        </div>

        <button class="btn" onclick="startQuizPhaseFromTutorial()" style="margin-top: 15px;">Continuar al Quiz</button>
      </div>

      <!-- Phase 2: Quiz -->
      <div id="prog-quiz-phase" style="display: none;">
        <h2 class="title">Nivel 5: Programa conmigo</h2>
        <p>Antes de empezar, aprende conceptos b√°sicos de programaci√≥n.</p>
        <p style="font-size: 0.9rem; color: #d4af37;">¬°Presta atenci√≥n, lo necesitar√°s!</p>

        <div style="margin: 15px 0;">
          <span>Pregunta: <span id="quiz-progress">1</span>/8</span>
        </div>

        <div id="quiz-question-container" style="background: #0a0a0a; padding: 15px; border: 2px solid #333; margin: 10px 0;">
          <p id="quiz-question" style="margin-bottom: 15px; font-size: 1rem;"></p>
          <div id="quiz-options" style="display: flex; flex-direction: column; gap: 8px;">
            <!-- Generated by JS -->
          </div>
        </div>

        <p id="quiz-feedback" style="margin: 10px 0; min-height: 20px;"></p>
      </div>

      <!-- Phase 2: Build Code -->
      <div id="prog-build-phase" style="display: none;">
        <h2 class="title">Fase 2: Construye el C√≥digo</h2>
        <p style="margin-bottom: 15px;">Ordena las l√≠neas para crear un programa que calcule cu√°ntos d√≠as llevan juntos.</p>

        <div id="code-lines-container" style="background: #0a0a0a; padding: 10px; border: 2px solid #333;">
          <!-- Generated by JS -->
        </div>

        <button class="btn" id="verify-order-btn" onclick="checkCodeOrder()" style="margin-top: 15px;">Verificar Orden</button>
        <p id="build-feedback" style="margin: 10px 0; min-height: 20px;"></p>

        <div id="build-output" style="display: none; margin-top: 15px;">
          <p style="color: #888; margin-bottom: 5px;">Resultado:</p>
          <div style="background: #000; padding: 10px; border: 1px solid #333;">
            <span style="color: #0ff;" id="build-console-output"></span>
          </div>
          <button class="btn" onclick="startPhase3()" style="margin-top: 15px;">Siguiente</button>
        </div>
      </div>

      <!-- Phase 3: Debug Code -->
      <div id="prog-debug-phase" style="display: none;">
        <h2 class="title">Fase 3: Encuentra los Errores</h2>
        <p style="margin-bottom: 10px;">Este c√≥digo tiene <span id="errors-remaining">5</span> errores. Encu√©ntralos y corr√≠gelos.</p>

        <div style="display: flex; gap: 5px; margin-bottom: 10px;">
          <button class="btn" onclick="runCode()" style="flex: 1; font-size: 0.85rem;">‚ñ∂ Ejecutar</button>
          <button class="btn" onclick="checkErrors()" style="flex: 1; font-size: 0.85rem;">‚úì Verificar</button>
          <button class="btn" onclick="showHelp()" style="flex: 1; font-size: 0.85rem;">? Ayuda</button>
        </div>

        <textarea id="code-editor" spellcheck="false" style="
          width: 100%;
          min-height: 250px;
          background: #0a0a0a;
          color: #fff;
          border: 2px solid #333;
          padding: 10px;
          font-family: 'Courier New', monospace;
          font-size: 0.85rem;
          resize: vertical;
        "></textarea>

        <div id="console-output" style="
          background: #000;
          border: 2px solid #333;
          padding: 10px;
          margin-top: 10px;
          min-height: 60px;
          font-family: 'Courier New', monospace;
          font-size: 0.8rem;
          color: #0f0;
        "></div>
      </div>
    </div>

    <!-- Pantalla de Nivel Completado -->
    <div id="level-complete-screen" class="screen">
      <h2 class="title">¬°Nivel Completado!</h2>

      <p class="success-message" id="level-complete-text"></p>

      <div class="prize-photo-container" id="prize-container">
        <p style="margin-bottom: 10px;">üéÅ Tu premio:</p>
        <div id="prize-content">
          <img id="prize-photo" class="prize-photo" src="" alt="Foto premio">
          <p class="prize-caption" id="prize-caption"></p>
        </div>
      </div>

      <p style="margin: 15px 0; font-size: 0.85rem; color: #888;">Tu C√≥digo de Amor:</p>
      <div class="love-code-display" id="complete-love-code"></div>

      <button class="btn" onclick="nextLevel()">Continuar</button>
    </div>

    <!-- Final Screen -->
    <div id="final-screen" class="screen">
      <h2 class="title">¬°Felicidades!</h2>

      <div class="final-message" id="final-full-message"></div>

      <div class="final-question">¬øQuieres ser mi Valent√≠n?</div>

      <button class="btn" onclick="sayYes()">S√ç</button>
      <button class="btn" onclick="sayYes()">¬°POR SUPUESTO!</button>
    </div>

    <!-- Pause Overlay -->
    <div id="pause-overlay" class="pause-overlay">
      <h2>PAUSADO</h2>
      <button class="btn" onclick="resumeGame()">‚ñ∂ CONTINUAR</button>
      <button class="btn btn-secondary" style="margin-top: 10px;" onclick="quitToMenu()">‚Üê VOLVER AL MEN√ö</button>
    </div>

    <!-- Fail Modal -->
    <div id="fail-modal" class="fail-modal">
      <div class="fail-modal-content">
        <h2 class="title" style="font-size: 1.5rem;">Fin del Juego</h2>
        <p id="fail-modal-msg" class="fail-message"></p>
        <div style="margin-top: 20px;">
          <button class="btn" id="fail-try-again-btn">Reintentar</button>
          <button class="btn btn-secondary" id="fail-go-back-btn">Volver</button>
        </div>
      </div>
    </div>

    <!-- Level 6: Treasure Hunt -->
    <div id="level-6-screen" class="screen">
      <h2 class="title">Nivel Final: Atrapa el Tesoro</h2>
      <p>Camina hacia el cofre...</p>

      <canvas id="treasure-canvas" width="320" height="180"></canvas>

      <div style="display: flex; gap: 10px; justify-content: center; margin-top: 10px;">
        <button class="btn" onclick="treasureJump()">‚Üë Saltar</button>
        <button class="btn" onclick="treasureMove(-1)">‚Üê Izq</button>
        <button class="btn" onclick="treasureMove(1)">Der ‚Üí</button>
      </div>

      <p class="hint-text">Flechas o botones para moverte, Espacio para saltar</p>
    </div>

    <!-- Yes Screen -->
    <div id="yes-screen" class="screen">
      <h2 class="title">¬°Sab√≠a que dir√≠as que s√≠!</h2>
      <img src="tacabecho.webp" alt="Nosotros" style="max-width: 200px; height: auto; margin: 20px 0; border-radius: 10px;">
      <p style="font-size: 3rem; margin: 20px 0;">¬°Te amo!</p>
    </div>
  </div>

  <canvas id="confetti-canvas" class="confetti"></canvas>

  <script>
    // ============================================================
    // ===== CUSTOMIZE HERE =======================================
    // ============================================================

    const TRIVIA_QUESTIONS = [
      {
        q: "¬øCu√°l fue la primera serie que terminamos juntos de principio a fin?",
        a: "chernobyl"
      },
      {
        q: "¬øC√≥mo se llama el lugar donde tuvimos nuestra primera noche salvaje?",
        a: "melody"
      },
      {
        q: "¬øQu√© pel√≠cula vimos en nuestro aniversario de un mes?",
        a: "la hora de la desaparicion"
      },
      {
        q: "¬øEn qu√© lugar y qui√©n captur√≥ nuestra primera foto como pareja?",
        a: [["su departamento", "departamento de alexis"], "alexis"],
        placeholders: ["¬øD√≥nde?", "¬øQui√©n la tom√≥?"]
      },
      {
        q: "Nombra nuestros dos postres favoritos (postre + marca)",
        a: ["helado grido", "tartaleta bahamas"],
        placeholders: ["Postre 1", "Postre 2"],
        anyOrder: true
      },
      {
        q: "¬øCu√°ndo pisaste mi departamento por primera vez? (dd/mm/aaaa)",
        a: "27/03/2025"
      },
    ];

    const MESSAGE_PIECES = [
      "Eres",
      "lo mejor que",
      "me ha pasado",
      "en la vida.",
      "¬°Te amo mucho!"
    ];

    // Prize photos - Use Google Drive direct links
    // ============================================================
    // ===== END CUSTOMIZATION ====================================
    // ============================================================

    // Game State
    let gameState = {
      currentLevel: 0,
      completedLevels: [],
      unlockedPieces: [],
      codeSecret: generateCodeSecret()
    };

    const FAIL_MESSAGES = [
      "¬øSeguro que me amas? Int√©ntalo de nuevo.",
      "Hmm, eso no es. ¬°Sigue intentando!",
      "¬°No! Pero creo en ti.",
      "¬°Mal! ¬°No te rindas con nosotros!",
      "Tan cerca... en realidad no. ¬°Int√©ntalo de nuevo!",
      "¬°Mi amor vale la pena el esfuerzo!"
    ];

    // Pause state
    let isPaused = false;
    let pausedLevel = null;

    function togglePause(level) {
      if (isPaused) {
        resumeGame();
      } else {
        isPaused = true;
        pausedLevel = level;
        document.getElementById('pause-overlay').classList.add('active');

        // Pause timers based on level
        if (level === 1 && catcherGame && catcherGame.timerInterval) {
          clearInterval(catcherGame.timerInterval);
        } else if (level === 2 && memoryGame && memoryGame.interval) {
          clearInterval(memoryGame.interval);
        } else if (level === 3 && mazeGame && mazeGame.interval) {
          clearInterval(mazeGame.interval);
        }
      }
    }

    function resumeGame() {
      isPaused = false;
      document.getElementById('pause-overlay').classList.remove('active');

      // Resume timers based on level
      if (pausedLevel === 1 && catcherGame && !catcherGame.gameOver) {
        catcherGame.timerInterval = setInterval(() => {
          catcherGame.timer--;
          document.getElementById('catcher-timer').textContent = catcherGame.timer;
          if (catcherGame.timer <= 0) {
            failLevel1();
          }
        }, 1000);
        requestAnimationFrame(updateHeartCatcher);
      } else if (pausedLevel === 2 && memoryGame) {
        startMemoryTimer();
      } else if (pausedLevel === 3 && mazeGame) {
        startMazeTimer();
      }

      pausedLevel = null;
    }

    function quitToMenu() {
      isPaused = false;
      document.getElementById('pause-overlay').classList.remove('active');

      // Clean up current game
      if (pausedLevel === 1 && catcherGame) {
        catcherGame.gameOver = true;
        document.removeEventListener('keydown', catcherKeyDown);
        document.removeEventListener('keyup', catcherKeyUp);
      } else if (pausedLevel === 2 && memoryGame) {
        clearInterval(memoryGame.interval);
      } else if (pausedLevel === 3 && mazeGame) {
        document.removeEventListener('keydown', mazeKeyDown);
      }

      pausedLevel = null;
      showLevelSelect();
    }

    const LEVEL_NAMES = [
      "Atr√°palo ranita!",
      "Memoria de Series",
      "Encuentrame! üîç",
      "Nos conoces?",
      "Programa conmigo"
    ];

    // Utility Functions
    function generateCodeSecret() {
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let result = '';
      for (let i = 0; i < 4; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return result;
    }

    function getLoveCode() {
      return `LOVE-${gameState.currentLevel}-${gameState.codeSecret}`;
    }

    function parseCode(code) {
      const match = code.toUpperCase().match(/^LOVE-(\d)-([A-Z0-9]{4})$/);
      if (match) {
        return { level: parseInt(match[1]), secret: match[2] };
      }
      return null;
    }

    function saveGame() {
      localStorage.setItem('loveQuest', JSON.stringify(gameState));
    }

    function loadGame() {
      const saved = localStorage.getItem('loveQuest');
      if (saved) {
        gameState = JSON.parse(saved);
        return true;
      }
      return false;
    }

    function showScreen(screenId) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
    }

    function randomFailMessage() {
      return FAIL_MESSAGES[Math.floor(Math.random() * FAIL_MESSAGES.length)];
    }

    let currentFailLevel = null;
    function showFailModal(level, retryFn) {
      currentFailLevel = level;
      document.getElementById('fail-modal-msg').textContent = randomFailMessage();
      document.getElementById('fail-modal').classList.add('active');

      // Set up button handlers
      document.getElementById('fail-try-again-btn').onclick = () => {
        document.getElementById('fail-modal').classList.remove('active');
        retryFn();
      };
      document.getElementById('fail-go-back-btn').onclick = () => {
        document.getElementById('fail-modal').classList.remove('active');
        showLevelSelect();
      };
    }

    // Start Screen Functions
    function checkForSavedGame() {
      if (loadGame() && gameState.currentLevel > 0) {
        document.getElementById('start-buttons').style.display = 'none';
        document.getElementById('resume-prompt').style.display = 'block';
        document.getElementById('resume-level').textContent = gameState.currentLevel;
      }
    }

    function showCodeInput() {
      document.getElementById('start-buttons').style.display = 'none';
      document.getElementById('code-input-section').style.display = 'block';
    }

    function hideCodeInput() {
      document.getElementById('code-input-section').style.display = 'none';
      document.getElementById('start-buttons').style.display = 'block';
      document.getElementById('code-error').style.display = 'none';
    }

    function loadFromCode() {
      const code = document.getElementById('love-code-input').value;
      const parsed = parseCode(code);

      if (parsed && parsed.level >= 0 && parsed.level <= 5) {
        gameState = {
          currentLevel: parsed.level,
          completedLevels: Array.from({length: parsed.level}, (_, i) => i + 1),
          unlockedPieces: MESSAGE_PIECES.slice(0, parsed.level),
          codeSecret: parsed.secret
        };
        saveGame();
        showLevelSelect();
      } else {
        document.getElementById('code-error').textContent = "C√≥digo inv√°lido. Int√©ntalo de nuevo.";
        document.getElementById('code-error').style.display = 'block';
      }
    }

    function startNewGame() {
      gameState = {
        currentLevel: 0,
        completedLevels: [],
        unlockedPieces: [],
        codeSecret: generateCodeSecret()
      };
      saveGame();
      showLevelSelect();
    }

    function resumeGame() {
      showLevelSelect();
    }

    // Level Select
    function showLevelSelect() {
      const grid = document.getElementById('level-select-grid');
      grid.innerHTML = '';

      for (let i = 1; i <= 5; i++) {
        const isCompleted = gameState.completedLevels.includes(i);
        const isUnlocked = i <= gameState.currentLevel + 1;
        const isCurrent = i === gameState.currentLevel + 1;

        const btn = document.createElement('div');
        btn.className = 'level-btn';
        if (isUnlocked) btn.classList.add('unlocked');
        if (isCompleted) btn.classList.add('completed');

        btn.innerHTML = `
          <span>${isUnlocked ? '' : 'üîí '}Nivel ${i}: ${LEVEL_NAMES[i-1]}</span>
          <span class="status">${isCompleted ? '‚úì Completado' : (isCurrent && isUnlocked ? '‚óè Jugar' : (isUnlocked ? 'Desbloqueado' : 'Bloqueado'))}</span>
        `;

        if (isUnlocked && !isCompleted) {
          btn.onclick = () => startLevel(i);
        } else if (isCompleted) {
          btn.onclick = () => startLevel(i);
        }

        grid.appendChild(btn);
      }

      // Add final level (Level 6: Treasure Hunt)
      const finalBtn = document.createElement('div');
      finalBtn.className = 'level-btn' + (gameState.completedLevels.length === 5 ? ' unlocked' : '');
      finalBtn.innerHTML = `
        <span>${gameState.completedLevels.length === 5 ? 'üíï' : 'üîí'} Nivel 6: Atrapa el Tesoro</span>
        <span class="status">${gameState.completedLevels.length === 5 ? '¬°Desbloqueado!' : 'Bloqueado'}</span>
      `;
      if (gameState.completedLevels.length === 5) {
        finalBtn.onclick = () => initTreasureHunt();
      }
      grid.appendChild(finalBtn);

      document.getElementById('current-love-code').textContent = getLoveCode();

      showScreen('level-select-screen');
    }

    function copyLoveCode() {
      navigator.clipboard.writeText(getLoveCode());
      alert('¬°C√≥digo copiado!');
    }

    function startLevel(level) {
      gameState.currentLevel = Math.max(gameState.currentLevel, level - 1);
      showScreen(`level-${level}-screen`);

      switch(level) {
        case 1: initHeartCatcher(); break;
        case 2: initMemoryMatch(); break;
        case 3: initMaze(); break;
        case 4: initTrivia(); break;
        case 5: initProgrammingGame(); break;
      }
    }

    function completeLevel(level) {
      if (!gameState.completedLevels.includes(level)) {
        gameState.completedLevels.push(level);
        gameState.unlockedPieces.push(MESSAGE_PIECES[level - 1]);
      }
      gameState.currentLevel = Math.max(gameState.currentLevel, level);
      saveGame();

      document.getElementById('level-complete-text').textContent = `¬°Completaste ${LEVEL_NAMES[level - 1]}!`;
      document.getElementById('complete-love-code').textContent = getLoveCode();

      // Show prize based on level
      const prizeContent = document.getElementById('prize-content');

      if (level === 1) {
        // Level 1: 2 Dr Peppers
        prizeContent.innerHTML = `
          <div style="display: flex; gap: 15px; justify-content: center; align-items: center;">
            <img src="game 1/pepper.webp" alt="Dr Pepper" style="width: 80px; height: auto;">
            <img src="game 1/pepper.webp" alt="Dr Pepper" style="width: 80px; height: auto;">
          </div>
          <p class="prize-caption">2 Dr Peppers ü•§ (Para canjear tu premio, debes enviar un SS üòâ)</p>
        `;
      } else if (level === 2) {
        // Level 2: Secret photos message
        prizeContent.innerHTML = `
          <div style="font-size: 2.5rem; margin-bottom: 10px;">üì∑</div>
          <p class="prize-caption" style="font-size: 1rem; line-height: 1.4;">
            Desbloqueaste fotos exclusivas, pero tendr√°s que canjearlas conmigo üëÄ<br>
            <span style="color: #d4af37;">Te espero.</span>
          </p>
        `;
      } else if (level === 3) {
        // Level 3: Hand-drawn picture
        prizeContent.innerHTML = `
          <img src="game 3/draw.png" alt="Dibujito" style="max-width: 150px; height: auto; margin-bottom: 10px;">
          <p class="prize-caption" style="font-size: 1rem; line-height: 1.4;">
            Un peque√±o y simple dibujito (pero hecho con amor igual uwu) espera ser reclamado.<br>
            <span style="color: #d4af37;">Recuerda canjearlo conmigo üëÄ</span>
          </p>
        `;
      } else if (level === 4) {
        // Level 4: Photo frame
        prizeContent.innerHTML = `
          <img src="game 4/frame.png" alt="Cuadrito" style="max-width: 150px; height: auto; margin-bottom: 10px;">
          <p class="prize-caption" style="font-size: 1rem; line-height: 1.4;">
            ¬øPuedes adivinar qu√© es?<br>
            Para que cada vez que lo veas, recuerdes lo mucho que nos amamos. ‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è
          </p>
        `;
      } else if (level === 5) {
        // Level 5: Knowledge is the prize (joke)
        prizeContent.innerHTML = `
          <img src="game 5/learn.png" alt="Aprendizaje" style="max-width: 150px; height: auto; margin-bottom: 10px;">
          <p class="prize-caption" style="font-size: 1rem; line-height: 1.4;">
            Tu premio es... <span style="color: #d4af37;">¬°haber aprendido!</span><br>
            No hay mejor regalo que el conocimiento üéì<br>
            (Y este no necesita env√≠o üòÖ)
          </p>
        `;
      }

      showScreen('level-complete-screen');
    }

    function nextLevel() {
      showLevelSelect();
    }

    // ============================================================
    // LEVEL 1: Heart Catcher
    // ============================================================
    let catcherGame = null;
    let catcherFailCount = 0; // Track how many times user failed Level 1

    // Preload images for Heart Catcher
    const heartImg = new Image();
    heartImg.src = 'heart.webp';
    const catcherHappyImg = new Image();
    catcherHappyImg.src = 'pepe-love.webp';
    const catcherHurtImg = new Image();
    catcherHurtImg.src = 'peppe-trash.webp';

    function initHeartCatcher() {
      const canvas = document.getElementById('heart-catcher-canvas');
      const ctx = canvas.getContext('2d');

      document.getElementById('catch-score').textContent = '0';
      document.getElementById('catcher-timer').textContent = '45';
      document.getElementById('lives-count').textContent = '‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è';
      document.getElementById('catcher-fail-msg').style.display = 'none';

      catcherGame = {
        catcher: { x: 130, width: 50, height: 50, baseWidth: 50, baseHeight: 50 },
        hearts: [],
        score: 0,
        lives: 3,
        gameOver: false,
        spawnTimer: 0,
        keys: { left: false, right: false },
        hurt: false,
        hurtTimer: 0,
        timer: 45,
        timerInterval: null,
        lastTimestamp: 0,
        frameAccumulator: 0
      };

      // Start countdown timer
      catcherGame.timerInterval = setInterval(() => {
        catcherGame.timer--;
        document.getElementById('catcher-timer').textContent = catcherGame.timer;
        if (catcherGame.timer <= 0) {
          failLevel1();
        }
      }, 1000);

      document.addEventListener('keydown', catcherKeyDown);
      document.addEventListener('keyup', catcherKeyUp);

      requestAnimationFrame(updateHeartCatcher);
    }

    function catcherKeyDown(e) {
      if (!catcherGame || isPaused) return;
      if (e.key === 'ArrowLeft' || e.key === 'a') catcherGame.keys.left = true;
      if (e.key === 'ArrowRight' || e.key === 'd') catcherGame.keys.right = true;
    }

    function catcherKeyUp(e) {
      if (!catcherGame || isPaused) return;
      if (e.key === 'ArrowLeft' || e.key === 'a') catcherGame.keys.left = false;
      if (e.key === 'ArrowRight' || e.key === 'd') catcherGame.keys.right = false;
    }

    function updateHeartCatcher(timestamp) {
      if (!catcherGame || catcherGame.gameOver || isPaused) {
        requestAnimationFrame(updateHeartCatcher);
        return;
      }

      const canvas = document.getElementById('heart-catcher-canvas');
      const ctx = canvas.getContext('2d');
      const g = catcherGame;

      // Delta time calculation for frame-rate independence
      if (!g.lastTimestamp) g.lastTimestamp = timestamp;
      const deltaTime = timestamp - g.lastTimestamp;
      g.lastTimestamp = timestamp;

      // Accumulate frames to run game logic at fixed 60 FPS
      g.frameAccumulator += deltaTime;
      const frameTime = 1000 / 60; // 60 FPS = ~16.67ms per frame

      // Run game logic in fixed time steps
      while (g.frameAccumulator >= frameTime) {
        g.frameAccumulator -= frameTime;

        // Move catcher
        if (g.keys.left) g.catcher.x = Math.max(0, g.catcher.x - 8);
        if (g.keys.right) g.catcher.x = Math.min(canvas.width - g.catcher.width, g.catcher.x + 8);

        // Spawn hearts with randomized timing to prevent patterns
        g.spawnTimer++;
        const spawnInterval = 25 + Math.random() * 30; // Random interval between 25-55 frames
        if (g.spawnTimer > spawnInterval) {
          g.spawnTimer = 0;

          // Spawn 1-2 hearts at different positions
          const heartsToSpawn = Math.random() < 0.3 ? 2 : 1;

        for (let j = 0; j < heartsToSpawn; j++) {
          // Determine heart type
          const roll = Math.random();
          let heartType = 'normal';
          let isBroken = false;

          // Jackpot only appears after 3+ failures, and only 2% chance
          if (catcherFailCount >= 3 && roll < 0.02) {
            heartType = 'jackpot'; // 2% chance after 3 failures - instant win!
          } else if (roll < 0.05) {
            heartType = 'extraLife'; // 5% chance - +1 life
          } else if (roll < 0.12) {
            heartType = 'golden'; // 7% chance - +2 points
          } else if (roll < 0.50) {
            isBroken = true; // 38% chance - broken heart
          }
          // Remaining 50% are normal good hearts

          // Spread hearts across different x positions
          const xSection = canvas.width / heartsToSpawn;
          const xPos = (j * xSection) + Math.random() * (xSection - 25);

          g.hearts.push({
            x: xPos,
            y: -30 - (j * 20), // Stagger vertically too
            broken: isBroken,
            type: heartType,
            speed: heartType === 'jackpot' ? 6 + Math.random() * 2 : 3 + Math.random() * 4, // Jackpot falls FAST
            age: 0,
            maxAge: heartType === 'jackpot' ? 100 : 150 // Jackpot fades faster too
          });
        }
      }

      // Update hearts
      for (let i = g.hearts.length - 1; i >= 0; i--) {
        const h = g.hearts[i];
        h.y += h.speed;
        h.age++;

        // Check if heart faded away
        if (!h.broken && h.age >= h.maxAge) {
          // Only normal hearts cost a life when fading - specials just disappear
          if (h.type === 'normal') {
            g.lives--;
            g.hurt = true;
            g.hurtTimer = 25; // Show peppe-trash
            updateLives();
            if (g.lives <= 0) {
              failLevel1();
              return;
            }
          }
          g.hearts.splice(i, 1);
          continue;
        }

        // Check catch
        if (h.y + 24 > canvas.height - g.catcher.height &&
            h.x + 16 > g.catcher.x &&
            h.x < g.catcher.x + g.catcher.width) {
          if (h.broken) {
            g.lives--;
            g.hurt = true;
            g.hurtTimer = 20; // Show sad face for 20 frames
            updateLives();
            if (g.lives <= 0) {
              failLevel1();
              return;
            }
          } else {
            // Handle special heart types
            if (h.type === 'jackpot') {
              // JACKPOT - Instant win!
              winLevel1();
              return;
            } else if (h.type === 'extraLife') {
              // Extra life (max 5)
              if (g.lives < 5) {
                g.lives++;
                updateLives();
              }
              g.score++;
            } else if (h.type === 'golden') {
              // Golden heart - +2 points
              g.score += 2;
            } else {
              // Normal heart - +1 point
              g.score++;
            }

            document.getElementById('catch-score').textContent = g.score;

            // Shrink catcher as score increases (min 20px)
            const shrinkAmount = 4;
            g.catcher.width = Math.max(20, g.catcher.baseWidth - (g.score * shrinkAmount));
            g.catcher.height = Math.max(20, g.catcher.baseHeight - (g.score * shrinkAmount));

            if (g.score >= 10) {
              winLevel1();
              return;
            }
          }
          g.hearts.splice(i, 1);
          continue;
        }

        // Check miss (heart fell off screen)
        if (h.y > canvas.height) {
          // Only normal good hearts cost a life - specials just disappear
          if (!h.broken && h.type === 'normal') {
            g.lives--;
            g.hurt = true;
            g.hurtTimer = 25; // Show peppe-trash
            updateLives();
            if (g.lives <= 0) {
              failLevel1();
              return;
            }
          }
          g.hearts.splice(i, 1);
        }
      }

        // Update hurt animation timer
        if (g.hurt && g.hurtTimer > 0) {
          g.hurtTimer--;
          if (g.hurtTimer <= 0) {
            g.hurt = false;
          }
        }
      } // End of fixed time step loop

      // Draw (happens at display refresh rate)
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Draw hearts
      const heartSize = 28;
      g.hearts.forEach(h => {
        // Calculate opacity for fading (only good hearts fade)
        let opacity = 1;
        if (!h.broken && h.age > h.maxAge * 0.5) {
          // Start fading at 50% of maxAge
          opacity = 1 - ((h.age - h.maxAge * 0.5) / (h.maxAge * 0.5));
          opacity = Math.max(0, opacity);
        }

        ctx.globalAlpha = opacity;

        if (h.broken) {
          // Use emoji for bad hearts
          ctx.font = '24px Arial';
          ctx.fillText('üíî', h.x, h.y + 24);
        } else if (h.type === 'jackpot') {
          // JACKPOT - Rainbow/trophy heart (pulsing effect)
          const pulse = 1 + Math.sin(h.age * 0.2) * 0.15;
          ctx.font = `${28 * pulse}px Arial`;
          ctx.fillText('üèÜ', h.x, h.y + 24);
        } else if (h.type === 'extraLife') {
          // Extra life - Green heart
          ctx.font = '24px Arial';
          ctx.fillText('üíö', h.x, h.y + 24);
        } else if (h.type === 'golden') {
          // Golden heart - Star/sparkle
          ctx.font = '24px Arial';
          ctx.fillText('‚≠ê', h.x, h.y + 24);
        } else {
          // Normal heart - Use custom image
          ctx.drawImage(heartImg, h.x, h.y, heartSize, heartSize);
        }

        ctx.globalAlpha = 1; // Reset opacity
      });

      // Draw catcher (pepe) - happy by default, hurt when catching bad heart
      const catcherImg = g.hurt ? catcherHurtImg : catcherHappyImg;
      ctx.drawImage(
        catcherImg,
        g.catcher.x,
        canvas.height - g.catcher.height - 5,
        g.catcher.width,
        g.catcher.height
      );

      requestAnimationFrame(updateHeartCatcher);
    }

    function updateLives() {
      const maxLives = 5;
      const hearts = '‚ù§Ô∏è'.repeat(catcherGame.lives) + 'üñ§'.repeat(Math.max(0, 3 - catcherGame.lives));
      document.getElementById('lives-count').textContent = hearts;
    }

    function failLevel1() {
      if (catcherGame.timerInterval) clearInterval(catcherGame.timerInterval);
      catcherFailCount++; // Track failures for jackpot unlock

      // Show peppe-trash for a moment before showing fail modal
      catcherGame.hurt = true;
      catcherGame.hurtTimer = 60;

      // Keep drawing for a bit to show peppe-trash
      const showTrashThenFail = () => {
        const canvas = document.getElementById('heart-catcher-canvas');
        const ctx = canvas.getContext('2d');
        const g = catcherGame;

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Draw catcher (peppe-trash)
        ctx.drawImage(
          catcherHurtImg,
          g.catcher.x,
          canvas.height - g.catcher.height - 5,
          g.catcher.width,
          g.catcher.height
        );

        g.hurtTimer--;
        if (g.hurtTimer > 0) {
          requestAnimationFrame(showTrashThenFail);
        } else {
          // Now show the fail modal
          catcherGame.gameOver = true;
          document.removeEventListener('keydown', catcherKeyDown);
          document.removeEventListener('keyup', catcherKeyUp);
          showFailModal(1, initHeartCatcher);
        }
      };

      showTrashThenFail();
    }

    function winLevel1() {
      catcherGame.gameOver = true;
      if (catcherGame.timerInterval) clearInterval(catcherGame.timerInterval);
      document.removeEventListener('keydown', catcherKeyDown);
      document.removeEventListener('keyup', catcherKeyUp);
      completeLevel(1);
    }

    // ============================================================
    // LEVEL 2: Memory Match
    // ============================================================
    let memoryGame = null;

    // Memory match images
    const MEMORY_IMAGES = [
      'series/fleabag.jpg',
      'series/angel beats.jpg.avif',
      'series/tgp.jpg',
      'series/eternauta.jpg.avif',
      'series/squid.avif',
      'series/severance.avif',
      'series/htgawm.jpg.avif',
      'series/chernobyl.jpg'
    ];

    function initMemoryMatch() {
      document.getElementById('memory-timer').textContent = '60';
      document.getElementById('pairs-matched').textContent = '0';
      document.getElementById('memory-fail-msg').style.display = 'none';

      const cards = [...MEMORY_IMAGES, ...MEMORY_IMAGES];

      // Shuffle
      for (let i = cards.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [cards[i], cards[j]] = [cards[j], cards[i]];
      }

      memoryGame = {
        cards: cards.map((symbol, i) => ({ id: i, symbol, flipped: false, matched: false })),
        flippedCards: [],
        matches: 0,
        locked: false,
        timer: 60,
        interval: null
      };

      renderMemoryGrid();
      startMemoryTimer();
    }

    function renderMemoryGrid() {
      const grid = document.getElementById('memory-grid');
      grid.innerHTML = '';

      memoryGame.cards.forEach((card, i) => {
        const cardEl = document.createElement('div');
        cardEl.className = 'memory-card' + (card.flipped ? ' flipped' : '') + (card.matched ? ' matched' : '');

        if (card.flipped || card.matched) {
          const img = document.createElement('img');
          img.src = card.symbol;
          img.alt = 'Card';
          cardEl.appendChild(img);
        }

        cardEl.onclick = () => flipCard(i);
        grid.appendChild(cardEl);
      });
    }

    function flipCard(index) {
      const g = memoryGame;
      if (g.locked || isPaused) return;

      const card = g.cards[index];
      if (card.flipped || card.matched) return;

      card.flipped = true;
      g.flippedCards.push(index);
      renderMemoryGrid();

      if (g.flippedCards.length === 2) {
        g.locked = true;
        const [first, second] = g.flippedCards;

        if (g.cards[first].symbol === g.cards[second].symbol) {
          g.cards[first].matched = true;
          g.cards[second].matched = true;
          g.matches++;
          document.getElementById('pairs-matched').textContent = g.matches;
          g.flippedCards = [];
          g.locked = false;
          renderMemoryGrid();

          if (g.matches === 8) {
            // Stop timer immediately
            clearInterval(g.interval);
            // Show the winning match for a moment before completing
            setTimeout(() => {
              winMemoryMatch();
            }, 1000);
          }
        } else {
          // First flip cards back
          setTimeout(() => {
            g.cards[first].flipped = false;
            g.cards[second].flipped = false;
            g.flippedCards = [];
            renderMemoryGrid();

            // Then highlight the cards that will swap
            setTimeout(() => {
              const cardEls = document.querySelectorAll('.memory-card');
              cardEls[first].classList.add('swapping');
              cardEls[second].classList.add('swapping');

              // After animation, swap them
              setTimeout(() => {
                swapClickedCards(first, second);
                g.locked = false;
                renderMemoryGrid();
              }, 700);
            }, 100);
          }, 500);
        }
      }
    }

    function swapClickedCards(index1, index2) {
      const g = memoryGame;
      // Swap the symbols of the two cards that were just clicked
      const temp = {
        symbol: g.cards[index1].symbol,
        id: g.cards[index1].id
      };
      g.cards[index1].symbol = g.cards[index2].symbol;
      g.cards[index1].id = g.cards[index2].id;
      g.cards[index2].symbol = temp.symbol;
      g.cards[index2].id = temp.id;
    }

    function startMemoryTimer() {
      memoryGame.interval = setInterval(() => {
        memoryGame.timer--;
        document.getElementById('memory-timer').textContent = memoryGame.timer;

        if (memoryGame.timer <= 0) {
          failMemoryMatch();
        }
      }, 1000);
    }

    function failMemoryMatch() {
      clearInterval(memoryGame.interval);
      showFailModal(2, initMemoryMatch);
    }

    function winMemoryMatch() {
      clearInterval(memoryGame.interval);
      completeLevel(2);
    }

    // ============================================================
    // LEVEL 3: Maze
    // ============================================================
    let mazeGame = null;

    // Preload images for Maze
    const alexisImg = new Image();
    alexisImg.src = 'game 3/alexis-optimized.png';
    const rocioImg = new Image();
    rocioImg.src = 'game 3/rocio-optimized.png';
    const foundImg = new Image();
    foundImg.src = 'game 3/found-small.jpg';

    const MAZE_LAYOUT = [
      [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
      [1,0,0,0,1,0,1,0,1,0,0,0,1,0,1],
      [1,1,1,0,1,0,1,0,1,0,1,0,1,0,1],
      [1,0,0,0,0,0,1,0,0,0,1,0,0,0,1],
      [1,0,1,1,1,1,1,1,1,1,1,1,1,0,1],
      [1,0,1,0,0,0,0,0,0,0,0,0,0,0,1],
      [1,0,1,0,1,1,1,0,1,1,1,1,1,1,1],
      [1,0,0,0,1,0,0,0,0,0,1,0,0,0,1],
      [1,1,1,1,1,0,1,1,1,0,1,0,1,0,1],
      [1,0,0,0,0,0,1,0,0,0,0,0,1,0,1],
      [1,0,1,1,1,1,1,0,1,1,1,1,1,0,1],
      [1,0,1,0,0,0,0,0,0,0,0,0,0,0,1],
      [1,0,1,0,1,1,1,1,1,1,1,1,1,1,1],
      [1,0,0,0,1,0,0,0,0,0,0,0,0,0,1],
      [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
    ];

    function initMaze() {
      document.getElementById('maze-timer').textContent = '35';
      document.getElementById('maze-fail-msg').style.display = 'none';

      mazeGame = {
        player: { x: 1, y: 1 },
        goal: { x: 5, y: 11 },
        visited: [[true]],
        timer: 35,
        interval: null
      };

      // Initialize visited array
      mazeGame.visited = Array(15).fill(null).map(() => Array(15).fill(false));
      mazeGame.visited[1][1] = true;

      document.addEventListener('keydown', mazeKeyDown);
      renderMaze();
      startMazeTimer();
    }

    function mazeKeyDown(e) {
      if (!mazeGame || isPaused) return;
      switch(e.key) {
        case 'ArrowUp':
        case 'ArrowDown':
        case 'ArrowLeft':
        case 'ArrowRight':
          e.preventDefault(); // Prevent page scrolling
          break;
      }
      switch(e.key) {
        case 'ArrowUp': moveMaze('up'); break;
        case 'ArrowDown': moveMaze('down'); break;
        case 'ArrowLeft': moveMaze('left'); break;
        case 'ArrowRight': moveMaze('right'); break;
      }
    }

    function moveMaze(dir) {
      if (!mazeGame || isPaused) return;

      const g = mazeGame;
      let newX = g.player.x;
      let newY = g.player.y;

      switch(dir) {
        case 'up': newY--; break;
        case 'down': newY++; break;
        case 'left': newX--; break;
        case 'right': newX++; break;
      }

      if (MAZE_LAYOUT[newY] && MAZE_LAYOUT[newY][newX] === 0) {
        g.player.x = newX;
        g.player.y = newY;
        g.visited[newY][newX] = true;
        renderMaze();

        if (g.player.x === g.goal.x && g.player.y === g.goal.y) {
          celebrateMazeWin();
        }
      }
    }

    function renderMaze() {
      const canvas = document.getElementById('maze-canvas');
      const ctx = canvas.getContext('2d');
      const cellSize = 20;
      const g = mazeGame;

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Draw maze with fog of war - tighter visibility
      for (let y = 0; y < 15; y++) {
        for (let x = 0; x < 15; x++) {
          const distX = Math.abs(x - g.player.x);
          const distY = Math.abs(y - g.player.y);
          // Only see directly adjacent cells (not diagonals)
          const inSight = (distX + distY) <= 1;
          const wasVisited = g.visited[y][x];

          if (inSight || wasVisited) {
            if (MAZE_LAYOUT[y][x] === 1) {
              ctx.fillStyle = inSight ? '#cc0033' : '#440011';
            } else {
              ctx.fillStyle = inSight ? '#1a1a1a' : '#0f0f0f';
            }
          } else {
            ctx.fillStyle = '#080808';
          }

          ctx.fillRect(x * cellSize, y * cellSize, cellSize, cellSize);
        }
      }

      // Draw player first
      drawCircularImage(ctx, alexisImg, g.player.x * cellSize + cellSize/2, g.player.y * cellSize + cellSize/2, cellSize * 1.8, '#cc0033');

      // Draw goal on top (only if in sight or visited)
      const goalDist = Math.abs(g.goal.x - g.player.x) + Math.abs(g.goal.y - g.player.y);
      if (goalDist <= 1 || g.visited[g.goal.y][g.goal.x]) {
        drawCircularImage(ctx, rocioImg, g.goal.x * cellSize + cellSize/2, g.goal.y * cellSize + cellSize/2, cellSize * 1.8, '#d4af37');
      }
    }

    function drawCircularImage(ctx, img, x, y, diameter, borderColor) {
      ctx.save();

      // Enable high-quality image smoothing
      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = 'high';

      // Draw glowing border
      ctx.beginPath();
      ctx.arc(x, y, diameter / 2 + 2, 0, Math.PI * 2);
      ctx.strokeStyle = borderColor;
      ctx.lineWidth = 3;
      ctx.shadowBlur = 8;
      ctx.shadowColor = borderColor;
      ctx.stroke();
      ctx.shadowBlur = 0;

      // Draw circular image
      ctx.beginPath();
      ctx.arc(x, y, diameter / 2, 0, Math.PI * 2);
      ctx.closePath();
      ctx.clip();
      ctx.drawImage(img, x - diameter / 2, y - diameter / 2, diameter, diameter);
      ctx.restore();
    }

    function startMazeTimer() {
      mazeGame.interval = setInterval(() => {
        mazeGame.timer--;
        document.getElementById('maze-timer').textContent = mazeGame.timer;

        if (mazeGame.timer <= 0) {
          failMaze();
        }
      }, 1000);
    }

    function celebrateMazeWin() {
      clearInterval(mazeGame.interval);
      document.removeEventListener('keydown', mazeKeyDown);

      const canvas = document.getElementById('maze-canvas');
      const ctx = canvas.getContext('2d');

      // Start confetti
      const confettiCanvas = document.getElementById('confetti-canvas');
      startConfetti();

      // Animation phases: fade in (30 frames) -> hold (30 frames) -> fade out (30 frames)
      let frame = 0;
      const fadeInFrames = 30;
      const holdFrames = 30;
      const fadeOutFrames = 30;
      const totalFrames = fadeInFrames + holdFrames + fadeOutFrames;

      function animateHearts() {
        if (frame >= totalFrames) {
          // Stop confetti
          confettiCanvas.style.display = 'none';
          ctx.clearRect(0, 0, canvas.width, canvas.height);

          // Animation done, complete the level
          setTimeout(() => {
            winMaze();
          }, 500);
          return;
        }

        // Re-render maze
        renderMaze();

        // Calculate opacity based on phase
        let opacity = 0;
        if (frame < fadeInFrames) {
          // Fade in
          opacity = frame / fadeInFrames;
        } else if (frame < fadeInFrames + holdFrames) {
          // Hold at full opacity
          opacity = 1;
        } else {
          // Fade out
          opacity = 1 - ((frame - fadeInFrames - holdFrames) / fadeOutFrames);
        }

        // Draw heart-shaped image in center with effects
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;

        // Slight pulse effect - grows slightly during hold phase
        let scale = 1;
        if (frame >= fadeInFrames && frame < fadeInFrames + holdFrames) {
          const holdProgress = (frame - fadeInFrames) / holdFrames;
          scale = 1 + Math.sin(holdProgress * Math.PI * 2) * 0.05; // Subtle pulse
        }

        const heartSize = 150 * scale;

        ctx.save();
        ctx.globalAlpha = opacity;

        // Add romantic glow effect
        ctx.shadowBlur = 25 * opacity;
        ctx.shadowColor = '#ff1744';

        // Draw the heart-shaped image
        ctx.drawImage(foundImg, centerX - heartSize / 2, centerY - heartSize / 2, heartSize, heartSize);

        ctx.restore();

        frame++;
        requestAnimationFrame(animateHearts);
      }

      animateHearts();
    }

    function failMaze() {
      clearInterval(mazeGame.interval);
      document.removeEventListener('keydown', mazeKeyDown);
      showFailModal(3, initMaze);
    }

    function winMaze() {
      clearInterval(mazeGame.interval);
      document.removeEventListener('keydown', mazeKeyDown);
      completeLevel(3);
    }

    // ============================================================
    // LEVEL 4: Trivia
    // ============================================================
    let triviaGame = null;

    function initTrivia() {
      document.getElementById('strikes-count').textContent = '0';
      document.getElementById('trivia-progress').textContent = '1';
      document.getElementById('trivia-fail-msg').style.display = 'none';
      document.getElementById('trivia-hint').style.display = 'none';

      triviaGame = {
        currentQuestion: 0,
        strikes: 0,
        attempts: 0
      };

      showTriviaQuestion();
    }

    function showTriviaQuestion() {
      const q = TRIVIA_QUESTIONS[triviaGame.currentQuestion];
      document.getElementById('trivia-question').textContent = q.q;
      document.getElementById('trivia-hint').style.display = 'none';
      triviaGame.attempts = 0;

      // Check if this question needs multiple inputs
      const container = document.getElementById('trivia-inputs-container');
      container.innerHTML = '';

      if (Array.isArray(q.a)) {
        // Multiple inputs needed
        const numInputs = q.a.length;
        for (let index = 0; index < numInputs; index++) {
          const input = document.createElement('input');
          input.type = 'text';
          input.className = 'trivia-input';
          input.id = `trivia-input-${index}`;
          input.placeholder = q.placeholders ? q.placeholders[index] : `Respuesta ${index + 1}`;
          input.style.marginBottom = '10px';
          container.appendChild(input);
        }
        document.getElementById('trivia-input-0').focus();
      } else {
        // Single input
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'trivia-input';
        input.id = 'trivia-input';
        input.placeholder = 'Escribe tu respuesta...';
        container.appendChild(input);
        document.getElementById('trivia-input').focus();
      }
    }

    function checkTriviaAnswer() {
      const q = TRIVIA_QUESTIONS[triviaGame.currentQuestion];
      let isCorrect = false;

      if (Array.isArray(q.a)) {
        // Check multiple inputs
        const inputs = q.a.map((_, index) => {
          const input = document.getElementById(`trivia-input-${index}`);
          return input ? input.value.trim().toLowerCase() : '';
        });

        if (q.anyOrder) {
          // Accept answers in any order
          const correctAnswers = q.a.map(a => Array.isArray(a) ? a.map(x => x.toLowerCase()) : [a.toLowerCase()]);
          const flatCorrect = correctAnswers.flat();

          // Check if all inputs are valid answers and no duplicates
          isCorrect = inputs.length === correctAnswers.length &&
                      inputs.every(input => flatCorrect.includes(input)) &&
                      new Set(inputs).size === inputs.length; // No duplicates
        } else {
          // All inputs must match in order
          isCorrect = inputs.every((input, index) => {
            const correctAnswer = q.a[index];
            // Check if answer accepts multiple options (array of valid answers)
            if (Array.isArray(correctAnswer)) {
              return correctAnswer.some(validAnswer => validAnswer.toLowerCase() === input);
            } else {
              return correctAnswer.toLowerCase() === input;
            }
          });
        }
      } else {
        // Check single input
        const input = document.getElementById('trivia-input');
        const userAnswer = input ? input.value.trim().toLowerCase() : '';
        const correctAnswer = q.a.toLowerCase();
        isCorrect = userAnswer === correctAnswer;
      }

      if (isCorrect) {
        triviaGame.currentQuestion++;
        document.getElementById('trivia-progress').textContent = triviaGame.currentQuestion + 1;

        if (triviaGame.currentQuestion >= 6) {
          winTrivia();
        } else {
          showTriviaQuestion();
        }
      } else {
        triviaGame.attempts++;
        triviaGame.strikes++;
        document.getElementById('strikes-count').textContent = triviaGame.strikes;

        if (triviaGame.strikes >= 3) {
          failTrivia();
        } else {
          const msg = document.getElementById('trivia-fail-msg');
          msg.textContent = randomFailMessage();
          msg.style.display = 'block';

          // Add shake animation to all inputs
          const container = document.getElementById('trivia-inputs-container');
          container.classList.add('shake');
          setTimeout(() => {
            container.classList.remove('shake');
            msg.style.display = 'none';
          }, 1000);
        }
      }
    }

    // Use event delegation for Enter key on trivia inputs
    document.getElementById('trivia-inputs-container').addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && e.target.classList.contains('trivia-input')) {
        checkTriviaAnswer();
      }
    });

    function failTrivia() {
      showFailModal(4, initTrivia);
    }

    function winTrivia() {
      completeLevel(4);
    }

    // ============================================================
    // LEVEL 5: Aprende a Programar
    // ============================================================
    let programmingGame = null;

    const QUIZ_QUESTIONS = [
      {
        q: "¬øC√≥mo se declara una variable?",
        options: ["var x = 5", "let x = 5", "variable x = 5"],
        correct: 1
      },
      {
        q: "¬øC√≥mo se escribe un texto (string)?",
        options: ["let nombre = Rocio", 'let nombre = "Rocio"', "let nombre = [Rocio]"],
        correct: 1
      },
      {
        q: "¬øC√≥mo se compara si dos valores son iguales?",
        options: ["x = y", "x == y", "x === y"],
        correct: 2
      },
      {
        q: "¬øQu√© hace i++ en un loop?",
        options: ["Resta 1", "Suma 1", "Multiplica por 2"],
        correct: 1
      },
      {
        q: "¬øC√≥mo se escribe un comentario?",
        options: ["// esto es un comentario", "# esto es un comentario", "/* esto es un comentario"],
        correct: 0
      },
      {
        q: "¬øC√≥mo se une (concatena) texto?",
        options: ['"Hola" + "Mundo"', '"Hola" & "Mundo"', '"Hola" . "Mundo"'],
        correct: 0
      },
      {
        q: "¬øQu√© hace console.log()?",
        options: ["Muestra un mensaje", "Borra la consola", "Crea una variable"],
        correct: 0
      },
      {
        q: "En un loop, ¬øqu√© hace i--?",
        options: ["Suma 1", "Resta 1", "No hace nada"],
        correct: 1
      }
    ];

    const CODE_LINES = [
      { id: 0, text: 'let fechaInicio = new Date("2025-02-24");', order: 0 },
      { id: 1, text: 'let fechaHoy = new Date();', order: 1 },
      { id: 2, text: 'let diferencia = fechaHoy - fechaInicio;', order: 2 },
      { id: 3, text: 'let diasConocidos = diferencia / (1000 * 60 * 60 * 24);', order: 3 },
      { id: 4, text: 'console.log("Nos conocemos desde hace " + diasConocidos + " d√≠as");', order: 4 }
    ];

    const BUGGY_CODE = `let pregunta = "¬øQuieres ser mi valent√≠n?;
let respuesta = "si";

if (respuesta = "s√≠") {
  let mensaje = "Te amo";

  for(let i = 1; i <= 3; i--) {
    console.log(mensaje + " ‚ù§Ô∏è);
  }
}

console.log("Tu amor llena al " + 100 "% mi coraz√≥n");`;

    const CORRECT_CODE = `let pregunta = "¬øQuieres ser mi valent√≠n?";
let respuesta = "si";

if (respuesta === "s√≠") {
  let mensaje = "Te amo";

  for(let i = 1; i <= 3; i++) {
    console.log(mensaje + " ‚ù§Ô∏è");
  }
}

console.log("Tu amor llena al " + 100 + "% mi coraz√≥n");`;

    function initProgrammingGame() {
      programmingGame = {
        phase: 1,
        quizIndex: 0,
        quizScore: 0,
        codeOrder: shuffleArray([...CODE_LINES]),
        errorsFound: 0
      };

      // Show tutorial phase directly
      document.getElementById('prog-intro-phase').style.display = 'none';
      document.getElementById('prog-tutorial-phase').style.display = 'block';
      document.getElementById('prog-quiz-phase').style.display = 'none';
      document.getElementById('prog-build-phase').style.display = 'none';
      document.getElementById('prog-debug-phase').style.display = 'none';
    }

    function startQuizPhaseFromTutorial() {
      programmingGame.phase = 2;
      document.getElementById('prog-tutorial-phase').style.display = 'none';
      document.getElementById('prog-quiz-phase').style.display = 'block';
      showQuizQuestion();
    }

    function shuffleArray(array) {
      const arr = [...array];
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    // ============================================================
    // PHASE 1: Quiz
    // ============================================================
    function showQuizQuestion() {
      const q = QUIZ_QUESTIONS[programmingGame.quizIndex];
      document.getElementById('quiz-progress').textContent = programmingGame.quizIndex + 1;
      document.getElementById('quiz-question').textContent = q.q;
      document.getElementById('quiz-feedback').textContent = '';

      const container = document.getElementById('quiz-options');
      container.innerHTML = '';

      q.options.forEach((option, index) => {
        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.textContent = `${String.fromCharCode(97 + index)}) ${option}`;
        btn.style.textAlign = 'left';
        btn.style.padding = '10px';
        btn.onclick = () => answerQuiz(index);
        container.appendChild(btn);
      });
    }

    function answerQuiz(selected) {
      const q = QUIZ_QUESTIONS[programmingGame.quizIndex];
      const feedback = document.getElementById('quiz-feedback');

      if (selected === q.correct) {
        programmingGame.quizScore++;
        feedback.textContent = '‚úì Correcto!';
        feedback.style.color = '#0f0';

        setTimeout(() => {
          programmingGame.quizIndex++;
          if (programmingGame.quizIndex >= QUIZ_QUESTIONS.length) {
            startPhase2();
          } else {
            showQuizQuestion();
          }
        }, 800);
      } else {
        feedback.textContent = '‚úó Incorrecto. La respuesta correcta era: ' + q.options[q.correct];
        feedback.style.color = '#cc0033';

        setTimeout(() => {
          programmingGame.quizIndex++;
          if (programmingGame.quizIndex >= QUIZ_QUESTIONS.length) {
            startPhase2();
          } else {
            showQuizQuestion();
          }
        }, 2000);
      }
    }

    // ============================================================
    // PHASE 2: Build Code
    // ============================================================
    function startPhase2() {
      programmingGame.phase = 2;
      document.getElementById('prog-quiz-phase').style.display = 'none';
      document.getElementById('prog-build-phase').style.display = 'block';

      renderCodeLines();
    }

    function renderCodeLines() {
      const container = document.getElementById('code-lines-container');
      container.innerHTML = '';

      programmingGame.codeOrder.forEach((line, index) => {
        const div = document.createElement('div');
        div.style.cssText = 'background: #111; border: 2px solid #333; padding: 10px; margin: 5px 0; cursor: pointer; display: flex; align-items: center; gap: 10px;';
        div.innerHTML = `
          <button onclick="moveLineUp(${index})" style="background: #cc0033; border: none; color: #fff; padding: 5px 10px; cursor: pointer;">‚ñ≤</button>
          <button onclick="moveLineDown(${index})" style="background: #cc0033; border: none; color: #fff; padding: 5px 10px; cursor: pointer;">‚ñº</button>
          <code style="flex: 1; font-family: 'Courier New', monospace; font-size: 0.85rem;">${line.text}</code>
        `;
        container.appendChild(div);
      });
    }

    function moveLineUp(index) {
      if (index === 0) return;
      const temp = programmingGame.codeOrder[index];
      programmingGame.codeOrder[index] = programmingGame.codeOrder[index - 1];
      programmingGame.codeOrder[index - 1] = temp;
      renderCodeLines();
    }

    function moveLineDown(index) {
      if (index === programmingGame.codeOrder.length - 1) return;
      const temp = programmingGame.codeOrder[index];
      programmingGame.codeOrder[index] = programmingGame.codeOrder[index + 1];
      programmingGame.codeOrder[index + 1] = temp;
      renderCodeLines();
    }

    function checkCodeOrder() {
      const order = programmingGame.codeOrder;
      const feedback = document.getElementById('build-feedback');

      // Get the IDs in current order
      const ids = order.map(line => line.id);

      // Valid orders: first two lines can be swapped
      const valid1 = [0, 1, 2, 3, 4]; // fechaInicio, fechaHoy, diferencia, diasJuntos, console.log
      const valid2 = [1, 0, 2, 3, 4]; // fechaHoy, fechaInicio, diferencia, diasJuntos, console.log

      const isValid1 = ids.every((id, idx) => id === valid1[idx]);
      const isValid2 = ids.every((id, idx) => id === valid2[idx]);

      if (isValid1 || isValid2) {
        feedback.textContent = '‚úì ¬°Correcto! El c√≥digo est√° en el orden perfecto.';
        feedback.style.color = '#0f0';

        // Calculate days since start date
        const fechaInicio = new Date("2025-02-24");
        const fechaHoy = new Date();
        const diferencia = fechaHoy - fechaInicio;
        const diasConocidos = Math.floor(diferencia / (1000 * 60 * 60 * 24));

        // Show output and next button
        document.getElementById('verify-order-btn').style.display = 'none';
        document.getElementById('build-console-output').textContent = 'Nos conocemos desde hace ' + diasConocidos + ' d√≠as';
        document.getElementById('build-output').style.display = 'block';
      } else {
        feedback.textContent = '‚úó El orden no es correcto. Sigue intentando.';
        feedback.style.color = '#cc0033';
      }
    }

    // ============================================================
    // PHASE 3: Debug Code
    // ============================================================
    function startPhase3() {
      programmingGame.phase = 3;
      document.getElementById('prog-build-phase').style.display = 'none';
      document.getElementById('prog-debug-phase').style.display = 'block';

      document.getElementById('code-editor').value = BUGGY_CODE;
      document.getElementById('console-output').textContent = '‚ñ∂ Ejecuta el c√≥digo para ver los errores';
    }

    function runCode() {
      const code = document.getElementById('code-editor').value;
      const output = document.getElementById('console-output');
      output.innerHTML = '';

      // Simulate running the code and finding errors (cryptic messages like real JS)
      const errors = [];

      if (!code.includes('?";')) errors.push('‚ùå L√≠nea 1: SyntaxError: Unexpected token');
      if (code.includes('if (respuesta = "')) errors.push('‚ö†Ô∏è L√≠nea 4: Warning: Possible assignment in condition');
      if (code.includes('i--')) errors.push('‚ö†Ô∏è L√≠nea 7: Warning: Infinite loop detected');
      if (!code.includes('‚ù§Ô∏è");')) errors.push('‚ùå L√≠nea 8: SyntaxError: Unexpected token');
      if (!code.includes('100 + "')) errors.push('‚ùå L√≠nea 12: SyntaxError: Unexpected string');

      if (errors.length === 0) {
        // Code is correct - simulate console.log output (show what the loop prints)
        output.innerHTML = `<span style="color: #0f0;">‚úì C√≥digo correcto! Ejecutando...</span><br><br><span style="color: #0ff;">Te amo ‚ù§Ô∏è<br>Te amo ‚ù§Ô∏è<br>Te amo ‚ù§Ô∏è<br>Tu amor llena al 100% mi coraz√≥n</span>`;
      } else {
        output.innerHTML = '<span style="color: #cc0033;">El c√≥digo tiene errores:</span><br><br>' + errors.join('<br>');
      }
    }

    function checkErrors() {
      const code = document.getElementById('code-editor').value.trim();
      const correctCode = CORRECT_CODE.trim();

      if (code === correctCode) {
        document.getElementById('console-output').innerHTML = '<span style="color: #0f0;">‚úì ¬°Perfecto! Todos los errores corregidos.</span>';
        setTimeout(() => winProgrammingGame(), 1500);
      } else {
        // Count remaining errors
        let remaining = 0;
        if (!code.includes('?";')) remaining++;
        if (code.includes('respuesta = "')) remaining++;
        if (code.includes('i--')) remaining++;
        if (!code.includes('‚ù§Ô∏è");')) remaining++;
        if (!code.includes('365 + "')) remaining++;

        document.getElementById('errors-remaining').textContent = remaining;
        document.getElementById('console-output').innerHTML = `<span style="color: #d4af37;">Quedan ${remaining} errores. Sigue buscando.</span>`;
      }
    }

    function showHelp() {
      const helpText = `
üìñ Gu√≠a de Sintaxis JavaScript:

‚Ä¢ Strings: "texto" o 'texto' (abrir y cerrar con la misma)
‚Ä¢ Comparar: === para verificar igualdad
‚Ä¢ Asignar: = para dar valor a variable
‚Ä¢ Loops: i++ incrementa, i-- decrementa
‚Ä¢ Concatenar: usar + entre strings
‚Ä¢ Variables: escribir el nombre exactamente
      `;
      document.getElementById('console-output').textContent = helpText;
    }

    function failProgrammingGame() {
      showFailModal(5, initProgrammingGame);
    }

    function winProgrammingGame() {
      completeLevel(5);
    }


    // ============================================================
    // LEVEL 6: Treasure Hunt (Side-Scroller Final Level)
    // ============================================================
    let treasureGame = null;

    function initTreasureHunt() {
      showScreen('level-6-screen');

      const canvas = document.getElementById('treasure-canvas');

      // Side-scroller setup
      treasureGame = {
        // Player
        x: 30,
        y: 130,
        width: 20,
        height: 30,
        vy: 0,
        onGround: true,
        facingRight: true,
        walkFrame: 0,

        // World
        groundY: 150,
        scrollX: 0,

        // Treasure chest position (at the end)
        chestX: 400,
        chestOpen: false,
        gameOver: false,

        // Movement
        moveDir: 0,
        keys: { left: false, right: false },

        // Effects
        sparkles: [],

        // Bushes (decorative)
        bushes: [
          { x: 60, size: 25 },
          { x: 120, size: 20 },
          { x: 200, size: 30 },
          { x: 280, size: 22 },
          { x: 350, size: 28 },
        ]
      };

      // Start game loop
      requestAnimationFrame(updateTreasure);
    }

    function treasureMove(dir) {
      if (!treasureGame || treasureGame.gameOver) return;
      treasureGame.moveDir = dir;
    }

    function treasureJump() {
      if (!treasureGame || treasureGame.gameOver) return;
      if (treasureGame.onGround) {
        treasureGame.vy = -8;
        treasureGame.onGround = false;
      }
    }

    // Keyboard controls
    document.addEventListener('keydown', (e) => {
      if (!treasureGame || treasureGame.gameOver) return;
      if (e.key === 'ArrowLeft' || e.key === 'a') treasureGame.keys.left = true;
      if (e.key === 'ArrowRight' || e.key === 'd') treasureGame.keys.right = true;
      if ((e.key === 'ArrowUp' || e.key === 'w' || e.key === ' ') && treasureGame.onGround) {
        treasureGame.vy = -8;
        treasureGame.onGround = false;
      }
    });

    document.addEventListener('keyup', (e) => {
      if (!treasureGame) return;
      if (e.key === 'ArrowLeft' || e.key === 'a') treasureGame.keys.left = false;
      if (e.key === 'ArrowRight' || e.key === 'd') treasureGame.keys.right = false;
    });

    function updateTreasure(timestamp) {
      if (!treasureGame) return;

      const canvas = document.getElementById('treasure-canvas');
      const ctx = canvas.getContext('2d');
      const g = treasureGame;

      // Handle continuous movement from keys
      if (g.keys.left) g.moveDir = -1;
      else if (g.keys.right) g.moveDir = 1;
      else if (!g.keys.left && !g.keys.right) g.moveDir = 0;

      // Move player
      const speed = 3;
      if (g.moveDir !== 0) {
        g.x += g.moveDir * speed;
        g.facingRight = g.moveDir > 0;
        g.walkFrame = (g.walkFrame + 0.2) % 2;
      }

      // Clamp player position
      g.x = Math.max(15, Math.min(g.x, g.chestX + 30));

      // Scroll camera to follow player
      const targetScroll = Math.max(0, g.x - 80);
      g.scrollX += (targetScroll - g.scrollX) * 0.1;

      // Gravity
      g.vy += 0.5;
      g.y += g.vy;

      // Ground collision
      if (g.y >= g.groundY - g.height/2) {
        g.y = g.groundY - g.height/2;
        g.vy = 0;
        g.onGround = true;
      }

      // Check if reached treasure
      if (g.x >= g.chestX - 20 && !g.chestOpen) {
        g.chestOpen = true;
        // Add sparkles
        for (let i = 0; i < 25; i++) {
          g.sparkles.push({
            x: g.chestX - g.scrollX,
            y: g.groundY - 25,
            vx: (Math.random() - 0.5) * 6,
            vy: -Math.random() * 5 - 2,
            life: 80,
            color: Math.random() > 0.5 ? '#d4af37' : '#cc0033'
          });
        }
        setTimeout(() => {
          g.gameOver = true;
          showFinalScreen();
        }, 2000);
      }

      // === RENDER ===

      // Sky gradient
      const skyGrad = ctx.createLinearGradient(0, 0, 0, g.groundY);
      skyGrad.addColorStop(0, '#1a0a1a');
      skyGrad.addColorStop(1, '#2a1a2a');
      ctx.fillStyle = skyGrad;
      ctx.fillRect(0, 0, 320, g.groundY);

      // Stars
      ctx.fillStyle = '#fff';
      for (let i = 0; i < 20; i++) {
        const sx = (i * 47 + 10) % 320;
        const sy = (i * 23 + 5) % (g.groundY - 20);
        const twinkle = Math.sin(timestamp / 500 + i) > 0.7 ? 2 : 1;
        ctx.beginPath();
        ctx.arc(sx, sy, twinkle, 0, Math.PI * 2);
        ctx.fill();
      }

      // Ground
      ctx.fillStyle = '#2d1f1f';
      ctx.fillRect(0, g.groundY, 320, 30);

      // Grass line
      ctx.strokeStyle = '#3d5a3d';
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(0, g.groundY);
      ctx.lineTo(320, g.groundY);
      ctx.stroke();

      // Draw bushes (parallax - move slower than player)
      g.bushes.forEach(bush => {
        const bx = bush.x - g.scrollX * 0.8;
        if (bx > -50 && bx < 370) {
          drawBush(ctx, bx, g.groundY, bush.size);
        }
      });

      // Draw treasure chest
      const chestScreenX = g.chestX - g.scrollX;
      if (chestScreenX > -50 && chestScreenX < 370) {
        drawChest(ctx, chestScreenX, g.groundY - 5, g.chestOpen, timestamp);
      }

      // Draw player
      const playerScreenX = g.x - g.scrollX;
      drawPlayer(ctx, playerScreenX, g.y, g.facingRight, g.walkFrame, g.onGround);

      // Draw sparkles
      g.sparkles.forEach(s => {
        s.x += s.vx;
        s.y += s.vy;
        s.vy += 0.15;
        s.life--;

        if (s.life > 0) {
          ctx.fillStyle = s.color;
          ctx.globalAlpha = s.life / 80;
          ctx.beginPath();
          ctx.arc(s.x, s.y, 3, 0, Math.PI * 2);
          ctx.fill();
          ctx.globalAlpha = 1;
        }
      });
      g.sparkles = g.sparkles.filter(s => s.life > 0);

      if (!g.gameOver) {
        requestAnimationFrame(updateTreasure);
      }
    }

    function drawBush(ctx, x, groundY, size) {
      ctx.fillStyle = '#2d4a2d';
      // Main bush shape (three overlapping circles)
      ctx.beginPath();
      ctx.arc(x, groundY - size/2, size/2, 0, Math.PI * 2);
      ctx.fill();
      ctx.beginPath();
      ctx.arc(x - size/3, groundY - size/3, size/3, 0, Math.PI * 2);
      ctx.fill();
      ctx.beginPath();
      ctx.arc(x + size/3, groundY - size/3, size/3, 0, Math.PI * 2);
      ctx.fill();

      // Highlights
      ctx.fillStyle = '#3d6a3d';
      ctx.beginPath();
      ctx.arc(x - 3, groundY - size/2 - 3, size/4, 0, Math.PI * 2);
      ctx.fill();
    }

    function drawChest(ctx, x, groundY, isOpen, timestamp) {
      const w = 35, h = 25;

      // Glow effect
      if (!isOpen) {
        ctx.shadowColor = '#d4af37';
        ctx.shadowBlur = 10 + Math.sin(timestamp / 200) * 5;
      }

      // Chest base
      ctx.fillStyle = '#8b4513';
      ctx.fillRect(x - w/2, groundY - h, w, h);

      // Chest lid
      ctx.fillStyle = '#a0522d';
      if (isOpen) {
        // Open lid tilted back
        ctx.save();
        ctx.translate(x - w/2, groundY - h);
        ctx.rotate(-0.8);
        ctx.fillRect(0, -8, w, 10);
        ctx.restore();

        // Heart inside
        ctx.font = '18px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('‚ù§Ô∏è', x, groundY - h/2 + 5);
      } else {
        ctx.fillRect(x - w/2 - 2, groundY - h - 8, w + 4, 10);
        // Lock
        ctx.fillStyle = '#d4af37';
        ctx.beginPath();
        ctx.arc(x, groundY - h/2, 4, 0, Math.PI * 2);
        ctx.fill();
      }

      ctx.shadowBlur = 0;
    }

    function drawPlayer(ctx, x, y, facingRight, walkFrame, onGround) {
      ctx.save();

      if (!facingRight) {
        ctx.translate(x, 0);
        ctx.scale(-1, 1);
        x = 0;
      }

      // Guy with mullet avatar
      const headY = y - 12;
      const bodyY = y;
      const legY = y + 10;

      // Black boots
      ctx.fillStyle = '#111';
      const legOffset = onGround ? Math.floor(walkFrame) * 3 : 0;
      ctx.fillRect(x - 5, legY + 4 + legOffset, 5, 5);
      ctx.fillRect(x + 0, legY + 4 - legOffset, 5, 5);
      // Boot detail
      ctx.fillStyle = '#222';
      ctx.fillRect(x - 5, legY + 4 + legOffset, 5, 2);
      ctx.fillRect(x + 0, legY + 4 - legOffset, 5, 2);

      // Legs (skin showing - black shorts)
      ctx.fillStyle = '#ffcc99';
      ctx.fillRect(x - 4, legY + 1, 3, 5 + legOffset);
      ctx.fillRect(x + 1, legY + 1, 3, 5 - legOffset);

      // Black shorts
      ctx.fillStyle = '#111';
      ctx.fillRect(x - 5, legY - 2, 10, 5);

      // White polo shirt
      ctx.fillStyle = '#fff';
      ctx.fillRect(x - 6, bodyY - 6, 12, 14);

      // Polo collar
      ctx.fillStyle = '#eee';
      ctx.beginPath();
      ctx.moveTo(x - 3, bodyY - 6);
      ctx.lineTo(x, bodyY - 3);
      ctx.lineTo(x + 3, bodyY - 6);
      ctx.lineTo(x + 5, bodyY - 6);
      ctx.lineTo(x, bodyY - 1);
      ctx.lineTo(x - 5, bodyY - 6);
      ctx.fill();

      // Collar outline
      ctx.strokeStyle = '#ccc';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(x - 4, bodyY - 6);
      ctx.lineTo(x, bodyY - 2);
      ctx.lineTo(x + 4, bodyY - 6);
      ctx.stroke();

      // Arms (white sleeves)
      ctx.fillStyle = '#fff';
      const armSwing = onGround ? Math.sin(walkFrame * Math.PI) * 0.3 : 0;
      ctx.fillRect(x - 10, bodyY - 4 + armSwing * 5, 5, 8);
      ctx.fillRect(x + 5, bodyY - 4 - armSwing * 5, 5, 8);
      // Hands
      ctx.fillStyle = '#ffcc99';
      ctx.fillRect(x - 10, bodyY + 3 + armSwing * 5, 4, 4);
      ctx.fillRect(x + 6, bodyY + 3 - armSwing * 5, 4, 4);

      // Head
      ctx.fillStyle = '#ffcc99';
      ctx.beginPath();
      ctx.arc(x, headY, 7, 0, Math.PI * 2);
      ctx.fill();

      // Mullet hair - front/top (shorter)
      ctx.fillStyle = '#3a2a1a';
      ctx.beginPath();
      ctx.ellipse(x, headY - 5, 7, 4, 0, Math.PI, 0);
      ctx.fill();

      // Mullet - the long back part
      ctx.fillStyle = '#3a2a1a';
      ctx.beginPath();
      ctx.moveTo(x + 5, headY - 2);
      ctx.quadraticCurveTo(x + 8, headY + 5, x + 6, headY + 15);
      ctx.lineTo(x + 3, headY + 14);
      ctx.quadraticCurveTo(x + 5, headY + 5, x + 5, headY);
      ctx.fill();

      // Side hair
      ctx.beginPath();
      ctx.ellipse(x - 6, headY, 3, 5, 0, 0, Math.PI * 2);
      ctx.fill();
      ctx.beginPath();
      ctx.ellipse(x + 6, headY, 3, 5, 0, 0, Math.PI * 2);
      ctx.fill();

      // Eyes
      ctx.fillStyle = '#000';
      ctx.fillRect(x - 4, headY - 1, 2, 2);
      ctx.fillRect(x + 2, headY - 1, 2, 2);

      // Smile
      ctx.strokeStyle = '#000';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.arc(x, headY + 2, 3, 0.1, Math.PI - 0.1);
      ctx.stroke();

      ctx.restore();
    }


    // ============================================================
    // Final Screen
    // ============================================================
    function showFinalScreen() {
      document.getElementById('final-full-message').textContent = MESSAGE_PIECES.join(' ');

      showScreen('final-screen');
      startConfetti();
    }

    function sayYes() {
      showScreen('yes-screen');
    }

    // ============================================================
    // Confetti
    // ============================================================
    function startConfetti() {
      const canvas = document.getElementById('confetti-canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;

      const particles = [];
      const colors = ['#cc0033', '#d4af37', '#8b0000', '#990022', '#fff', '#b8860b'];

      for (let i = 0; i < 150; i++) {
        particles.push({
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height - canvas.height,
          size: Math.random() * 8 + 4,
          color: colors[Math.floor(Math.random() * colors.length)],
          speed: Math.random() * 3 + 2,
          angle: Math.random() * Math.PI * 2,
          spin: (Math.random() - 0.5) * 0.2
        });
      }

      function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        particles.forEach(p => {
          p.y += p.speed;
          p.x += Math.sin(p.angle) * 0.5;
          p.angle += p.spin;

          if (p.y > canvas.height) {
            p.y = -10;
            p.x = Math.random() * canvas.width;
          }

          ctx.fillStyle = p.color;
          ctx.beginPath();
          ctx.arc(p.x, p.y, p.size / 2, 0, Math.PI * 2);
          ctx.fill();
        });

        requestAnimationFrame(animate);
      }

      animate();
    }

    // Global key handler for pause (Escape key)
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        // Determine which level is active
        if (document.getElementById('level-1-screen').classList.contains('active')) {
          togglePause(1);
        } else if (document.getElementById('level-2-screen').classList.contains('active')) {
          togglePause(2);
        } else if (document.getElementById('level-3-screen').classList.contains('active')) {
          togglePause(3);
        }
      }
    });

    // Initialize
    checkForSavedGame();
  </script>
</body>
</html>
